
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Rules for the top-level `users` collection (if you have one for profiles)
    match /users/{userId} {
      // Only the user themselves can read or write to their own profile document.
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // Rules for the multi-tenant `restaurants` collection
    // This is the core of the multi-tenant security model.
    match /restaurants/{restaurantId}/{document=**} {
      // In a real app, you would check a custom claim on the user's auth token
      // that lists which restaurants they have access to.
      // e.g., `allow read, write: if isSignedIn() && restaurantId in request.auth.token.restaurants;`
      // For now, since we don't have full auth logic, we will allow any signed-in user
      // to access data within any restaurant. THIS IS FOR DEVELOPMENT ONLY.
      allow read, write: if isSignedIn();
    }

    // ======================================================================
    // The rules below are now obsolete because access is controlled by the
    // /restaurants/{restaurantId} rule above. They are removed to prevent
    // any potential conflicts or security holes. All data must be nested.
    // ======================================================================
  }
}
