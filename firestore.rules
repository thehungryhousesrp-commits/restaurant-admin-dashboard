rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function getRole(restaurantId) {
      return get(/databases/$(database)/documents/restaurants/$(restaurantId)/staff/$(request.auth.uid)).data.role;
    }

    function isOwner(restaurantId) {
        return get(/databases/$(database)/documents/restaurants/$(restaurantId)).data.ownerId == request.auth.uid;
    }

    function isManager(restaurantId) {
        return isOwner(restaurantId) || getRole(restaurantId) == 'manager';
    }

    function isCashier(restaurantId) {
        return isManager(restaurantId) || getRole(restaurantId) == 'cashier';
    }

    function isStaff(restaurantId) {
        return exists(/databases/$(database)/documents/restaurants/$(restaurantId)/staff/$(request.auth.uid));
    }

    // Authenticated users can read their own user document.
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
    }

    // Rules for restaurants and their subcollections
    match /restaurants/{restaurantId} {
      allow read: if isOwner(restaurantId) || isStaff(restaurantId);
      allow update: if isOwner(restaurantId);
      // Users cannot create or delete restaurants directly; this must be done via a Cloud Function.
      allow create, delete: if false;

      // Managers can edit the menu, Cashiers can only read it
      match /menu/{itemId} {
        allow read: if isCashier(restaurantId);
        allow write: if isManager(restaurantId);
      }

      // Cashiers can create and read orders, but only Managers can update/delete them
      match /orders/{orderId} {
        allow read, create: if isCashier(restaurantId);
        allow update, delete: if isManager(restaurantId);
      }

      // Owners are the only ones who can manage staff
      match /staff/{userId} {
          allow read, write: if isOwner(restaurantId);
      }
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    // Allow owners to upload logos to a specific path for their restaurant.
    match /restaurants/{restaurantId}/logo/{fileName} {
      // Users can only write to their own restaurant's folder.
      allow write: if request.auth != null && resource.size < 2 * 1024 * 1024 // Max 2MB
                      && resource.contentType.matches('image/.*')
                      && get(/databases/(default)/documents/restaurants/$(restaurantId)).data.ownerId == request.auth.uid;

      // Anyone can read the logos. This is safe as they are public branding assets.
      allow read: if true;
    }

    // Deny all other writes to storage by default.
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
